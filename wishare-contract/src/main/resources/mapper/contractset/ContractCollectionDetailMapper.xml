<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wishare.contract.domains.mapper.contractset.ContractCollectionDetailMapper">
    <!-- 表字段展示 ,xml不会在表字段更新后更新，
    com.wishare.contract.domains.consts.contractset.ContractCollectionDetailFieldConst 会每次重新生成
    可以从javadoc中获取到最新的表字段列表-->
    <!-- id,contractId,collectionPlanId,invoice,receiptNumber,serialNumber,remark,receivedAmount,
    collectionType,receiptVoucher,userId,userName,collectionTime,tenantId,deleted,
    creator,creatorName,gmtCreate,operator,operatorName,gmtModify -->
    <select id="selectByCollectionPlanId"
            resultType="com.wishare.contract.domains.vo.contractset.CollectionDetailPlanV">
        SELECT
            ccp.summary,
            ccp.plannedCollectionAmount,
            ccp.plannedCollectionTime,
            ccd.id,
            ccd.contractId,
            ccd.collectionPlanId,
            ccd.invoice,
            ccd.receiptNumber,
            ccd.serialNumber,
            ccd.remark,
            ccd.receivedAmount,
            ccd.collectionType,
            ccd.receiptVoucher,
            ccd.userId,
            ccd.userName,
            ccd.collectionTime,
            ccd.tenantId,
            ccd.deleted,
            ccd.creator,
            ccd.creatorName,
            ccd.gmtCreate,
            ccd.operator,
            ccd.operatorName,
            ccd.gmtModify,
            ccd.receiptVoucherName
        FROM
            contract_collection_detail ccd
            LEFT JOIN contract_collection_plan ccp ON ccd.collectionPlanId = ccp.id
        WHERE
            ccd.deleted = 0
            AND ccp.deleted = 0
            <if test="contractId != null and contractId != 0">
                AND ccd.contractId = #{contractId}
            </if>
            <if test="collectionPlanId != null and collectionPlanId !=0">
                AND ccd.collectionPlanId = #{collectionPlanId}
            </if>
            <if test="tenantId != null and tenantId !=''">
                AND ccd.tenantId = #{tenantId}
            </if>
        ORDER BY
            ccd.gmtModify DESC
    </select>

    <delete id="deleteByCollectionPlanId">
        UPDATE contract_collection_detail
            SET deleted = 1
        WHERE
            collectionPlanId = #{collectionPlanId}
    </delete>

    <delete id="deleteByContractId">
        UPDATE contract_collection_detail
            SET deleted = 1
        WHERE
            contractId = #{contractId}
    </delete>

    <select id="selectCountCurrentDate" resultType="java.lang.Long">
        SELECT
            COUNT(1)
        FROM
            contract_collection_detail
        WHERE
            DATE_FORMAT(gmtCreate,"%Y-%m-%d") = DATE_FORMAT(NOW(),"%Y-%m-%d")
    </select>

</mapper>
